<!doctype html>
<html lang="tg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TradeWay TJ ‚Äî –î”Ø–∫–æ–Ω–∏ –æ–Ω–ª–∞–π–Ω</title>
  <meta name="description" content="–î”Ø–∫–æ–Ω–∏ –æ–Ω–ª–∞–π–Ω –±–æ —Å–∞–±–∞–¥–∏ —Ñ–∞—ä–æ–ª –≤–∞ –∏—Ä—Å–æ–ª–∏ —Ñ–∞—Ä–º–æ–∏—à –±–∞ Google Sheets">
  <style>
    :root{
      --bg:#0f172a; --surface:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --primary:#22c55e; --card:#0b1220; --border:#1f2937; --danger:#ef4444;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(180deg,var(--bg),#0b1022 40%,#0b0f1a);color:var(--text);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial;min-height:100vh;overflow-x:hidden}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    a{color:inherit;text-decoration:none}

    header{position:sticky;top:0;z-index:50;backdrop-filter:saturate(140%) blur(10px);background:rgba(10,14,25,.8);border-bottom:1px solid var(--border)}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:8px;font-weight:800}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:conic-gradient(var(--primary),#10b981)}

    .input{display:flex;align-items:center;gap:8px;background:#0b1325;border:1px solid var(--border);border-radius:12px;padding:6px 10px;min-width:220px;flex:1}
    .input input{all:unset;color:var(--text);width:100%}
    .btn{border:1px solid var(--border);background:#0c152a;padding:8px 12px;border-radius:12px;color:var(--text);cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#1a2c22;color:#04170b;font-weight:700}

    .hero{text-align:center;padding:22px 0 10px}
    .title{font-size:24px;font-weight:800}
    .subtitle{color:var(--muted);font-size:14px}

    .categories{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:14px 0}
    .cat-btn{background:#0c152a;border:1px solid var(--border);padding:6px 12px;border-radius:10px;cursor:pointer}
    .cat-btn.active{background:var(--primary);color:#04170b;font-weight:700}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;padding-bottom:40px}
    .card{background:linear-gradient(180deg,#0a1220,var(--card));border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;transition:transform .25s}
    .card:hover{transform:translateY(-3px)}
    .thumb{aspect-ratio:4/3;background:#0a0e18;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .name{font-weight:600;font-size:15px}
    .price{font-weight:800;font-size:16px;color:#bbf7d0}
    .add{margin-top:auto}

    /* Cart */
    .cart-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:60}
    .cart{position:fixed;right:0;top:0;height:100vh;width:360px;max-width:100%;background:#0b1325;border-left:1px solid var(--border);box-shadow:-10px 0 30px rgba(0,0,0,.3);transform:translateX(105%);transition:transform .25s;z-index:61;display:flex;flex-direction:column}
    .cart.open{transform:translateX(0)}
    .cart-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .cart-items{padding:10px;overflow:auto;flex:1}
    .cart-row{display:grid;grid-template-columns:64px 1fr auto;gap:8px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:#0a1324;margin-bottom:8px}
    .cart-row img{width:64px;height:64px;object-fit:cover;border-radius:8px}
    .row-actions button{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:#0c152a;color:var(--text);cursor:pointer}
    .cart-footer{border-top:1px solid var(--border);padding:12px;display:grid;gap:8px}
    .total{display:flex;align-items:center;justify-content:space-between;font-weight:800}

    @media (max-width:768px){.title{font-size:20px}.btn{font-size:13px}}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand"><span class="dot"></span><span>TradeWay TJ</span></div>
      <div class="input"><input id="search" placeholder="“∂—É—Å—Ç—É“∑”Ø–∏ –º–∞“≥—Å—É–ª–æ—Ç..." /></div>
      <button id="openCart" class="btn">üõí –°–∞–±–∞–¥ <span id="cartCount">0</span></button>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1 class="title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è“≥–æ</h1>
      <p class="subtitle">–ò–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —ë “∑—É—Å—Ç—É“∑”Ø –∫—É–Ω–µ–¥.</p>
      <div id="categories" class="categories"></div>
    </section>
    <section><div id="grid" class="grid"></div></section>
  </main>

  <!-- Cart -->
  <div id="overlay" class="cart-overlay"></div>
  <aside id="cartPanel" class="cart">
    <div class="cart-header">
      <strong>–°–∞–±–∞–¥</strong>
      <button id="closeCart" class="btn">‚úï</button>
    </div>
    <div id="cartItems" class="cart-items"></div>
    <div class="cart-footer">
      <div class="total">“≤–∞–º–∞–≥”£: <span id="cartTotal">0 —Å–æ–º–æ–Ω”£</span></div>
      <button id="checkout" class="btn primary">–§–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω–∏ —Ñ–∞—Ä–º–æ–∏—à</button>
      <button id="clear" class="btn" style="background:#581515;color:#fff;border-color:#5a1a1a">–ü–æ–∫ –∫–∞—Ä–¥–∞–Ω–∏ —Å–∞–±–∞–¥</button>
    </div>
  </aside>

  <script>
    /* === 1) –ù–ê–°–¢–†–û–ô–ö–ò === */

    // –¢–í–û–ô Apps Script –¥–ª—è –ø—Ä–∏—ë–º–∞ –∑–∞–∫–∞–∑–æ–≤
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw3wsocC-b85NvJ2S0jrW_uLR39MYSJNWy5GDgF7Je0qNvWT_9Ncnkwm0k5RkSo25vf/exec';

    // –ü–£–ë–õ–ò–ö–û–í–ê–ù–ù–ê–Ø —Å—Å—ã–ª–∫–∞ —Ç–∞–±–ª–∏—Ü—ã -> gviz JSON (–ª–∏—Å—Ç products)
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –¥—Ä—É–≥–æ–π ID –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ.
    const SHEET_URL =
      'https://docs.google.com/spreadsheets/d/e/2PACX-1vQpIR_sMPcVIkHY9EqBhyLYwEz-AqhNV64SCrT_nRiukBFFpmzU13uASf5YeUbnBShga4gowbGxxndo/gviz/tq?tqx=out:json&sheet=products';

    /* === 2) –°–û–°–¢–û–Ø–ù–ò–ï === */
    let products = [];                       // —Å—é–¥–∞ –∑–∞–≥—Ä—É–∑–∏–º —Ç–æ–≤–∞—Ä—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
    const state = { cart:new Map(), filter:'“≤–∞–º–∞' };
    const fmt   = n => (+n||0).toLocaleString('ru-RU');

    /* === 3) –†–ï–ù–î–ï–† –ö–ê–¢–ï–ì–û–†–ò–ô === */
    const catsDiv  = document.getElementById('categories');
    const grid     = document.getElementById('grid');
    const searchEl = document.getElementById('search');

    function getCategories() {
      const set = new Set(products.map(p => (p.cat||'').trim()).filter(Boolean));
      return ['“≤–∞–º–∞', ...Array.from(set)];
    }

    function renderCats(){
      const cats = getCategories();
      catsDiv.innerHTML = cats.map(c =>
        `<button class="cat-btn ${state.filter===c?'active':''}" onclick="setCat('${c.replace(/'/g,"\\'")}')">${c}</button>`
      ).join('');
    }

    function setCat(c){ state.filter=c; renderCats(); renderGrid(); }

    /* === 4) –ö–ê–†–¢–û–ß–ö–ò –¢–û–í–ê–†–û–í === */
    function card(p){
      return `
        <article class="card">
          <div class="thumb"><img src="${p.img}" alt="${p.name}"></div>
          <div class="body">
            <div class="name">${p.name}</div>
            <div class="price">${fmt(p.price)} —Å–æ–º–æ–Ω”£</div>
            <button class="btn add" onclick="updateCart(${JSON.stringify(p._key)},1)">–ò–ª–æ–≤–∞ –±–∞ —Å–∞–±–∞–¥</button>
          </div>
        </article>`;
    }

    function renderGrid(){
      const q = (searchEl.value||'').toLowerCase().trim();
      const list = products.filter(p =>
        (state.filter==='“≤–∞–º–∞' || p.cat===state.filter) &&
        (p.name.toLowerCase().includes(q) || p.cat.toLowerCase().includes(q))
      );
      grid.innerHTML = list.length ? list.map(card).join('') : `<p style="opacity:.7">–ú–∞“≥—Å—É–ª–æ—Ç —ë—Ñ—Ç –Ω–∞—à—É–¥ üòï</p>`;
    }

    /* === 5) –ö–û–†–ó–ò–ù–ê === */
    function updateCart(key, delta){
      const p = products.find(x => x._key === key);
      if(!p) return;
      const item = state.cart.get(key) || { product:p, qty:0 };
      item.qty = Math.max(0, item.qty + delta);
      if(item.qty===0) state.cart.delete(key); else state.cart.set(key, item);
      renderCart();
    }

    function renderCart(){
      const box = document.getElementById('cartItems');
      let total = 0, count = 0;
      box.innerHTML = '';
      state.cart.forEach(({product,qty}) => {
        total += (product.price||0) * qty;
        count += qty;
        box.innerHTML += `
          <div class="cart-row">
            <img src="${product.img}" alt="${product.name}">
            <div>
              <div style="font-weight:600">${product.name}</div>
              <div style="opacity:.8">${fmt(product.price)} —Å–æ–º–æ–Ω”£ √ó ${qty}</div>
            </div>
            <div class="row-actions">
              <button onclick="updateCart(${JSON.stringify(product._key)},-1)">‚àí</button>
              <span style="display:inline-block;width:24px;text-align:center">${qty}</span>
              <button onclick="updateCart(${JSON.stringify(product._key)},1)">+</button>
            </div>
          </div>`;
      });
      document.getElementById('cartTotal').textContent  = fmt(total) + ' —Å–æ–º–æ–Ω”£';
      document.getElementById('cartCount').textContent  = count;
    }

    function openCart(){ document.getElementById('cartPanel').classList.add('open'); document.getElementById('overlay').style.display='block'; }
    function closeCart(){ document.getElementById('cartPanel').classList.remove('open'); document.getElementById('overlay').style.display='none'; }

    /* === 6) –û–¢–ü–†–ê–í–ö–ê –ó–ê–ö–ê–ó–ê === */
    async function sendOrder(){
      if(state.cart.size===0){ alert('–°–∞–±–∞–¥ —Ö–æ–ª”£ –∞—Å—Ç'); return; }
      const items = Array.from(state.cart.values()).map(({product,qty}) => ({
        id: product.id, name: product.name, price: +product.price||0, qty, subtotal: (+product.price||0)*qty
      }));
      const total = items.reduce((s,i)=>s+i.subtotal,0);
      const order = {
        action:'order',
        items, total, currency:'—Å–æ–º–æ–Ω”£',
        customer:{
          name:   prompt('–ù–æ–º–∏ —Ö—É–¥—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥:')      || '',
          phone:  prompt('–†–∞“õ–∞–º–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏ —Ö—É–¥—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥:') || '',
          address:prompt('–°—É—Ä–æ“ì–∞–∏ —Ö—É–¥—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥:')   || ''
        }
      };
      try{
        // no-cors: —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å –Ω–∞ CORS, –æ—Ç–≤–µ—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–µ–º ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ–∞–∫—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(order) });
        alert('‚úÖ –§–∞—Ä–º–æ–∏—à —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞ —à—É–¥!');
        state.cart.clear(); renderCart(); closeCart();
      }catch(e){
        alert('‚ùå –•–∞—Ç–æ “≥–∞–Ω–≥–æ–º–∏ —Ñ–∏—Ä–∏—Å—Ç–æ–¥–∞–Ω–∏ —Ñ–∞—Ä–º–æ–∏—à: ' + e.message);
      }
    }

    /* === 7) –ó–ê–ì–†–£–ó–ö–ê –ò–ó GOOGLE SHEETS === */
    async function loadProducts(){
      try{
        const res  = await fetch(SHEET_URL);
        const txt  = await res.text();
        // –æ—Ç–≤–µ—Ç gviz –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å "/*O_o*/\ngoogle.visualization.Query.setResponse("
        const json = JSON.parse(txt.substring(47).slice(0,-2));
        const rows = json.table.rows || [];
        products = rows.map(r => {
          const id    = r.c[0]?.v ?? '';
          const cat   = (r.c[1]?.v ?? '').toString();
          const name  = (r.c[2]?.v ?? '').toString();
          const price = Number(r.c[3]?.v ?? 0);
          const img   = (r.c[4]?.v ?? '').toString();
          return { id, cat, name, price, img, _key: `${id}__${name}` };
        }).filter(p => p.name);
        renderCats(); renderGrid();
      }catch(e){
        console.error(e);
        grid.innerHTML = `<p style="opacity:.8">–•–∞—Ç–æ “≥–∞–Ω–≥–æ–º–∏ –±–æ—Ä–∫—É–Ω–∏–∏ –º–∞—ä–ª—É–º–æ—Ç –∞–∑ Google Sheets.</p>`;
      }
    }

    /* === 8) –°–õ–£–®–ê–¢–ï–õ–ò === */
    document.getElementById('openCart').addEventListener('click',openCart);
    document.getElementById('closeCart').addEventListener('click',closeCart);
    document.getElementById('overlay').addEventListener('click',closeCart);
    document.getElementById('clear').addEventListener('click',()=>{ state.cart.clear(); renderCart(); });
    document.getElementById('checkout').addEventListener('click',sendOrder);
    searchEl.addEventListener('input',renderGrid);

    /* === 9) –°–¢–ê–†–¢ === */
    loadProducts();
  </script>
</body>
</html>
